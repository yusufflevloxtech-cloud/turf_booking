<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr.360 Turf Booking</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <h1>Turf Slot Booking</h1>

    <div class="section">
        <h2>Choose Your Sport</h2>
        <div class="radio-group">
            <label class="radio-label"><input type="radio" name="sport" value="football" checked required> Football</label>
            <label class="radio-label"><input type="radio" name="sport" value="cricket" required> Cricket</label>
            <label class="radio-label"><input type="radio" name="sport" value="volleyball" required> Pickleball</label>
        </div>
    </div>

    <div class="section">
        <h2>Choose Date and Time</h2>
        <input type="date" id="bookingDate" class="input-date" required>
        <span id="dateError" style="color:red;display:none;">Please select a date.</span>
    </div>

    <div class="section">
        <h3 id="slotHeader">Available Slots for : <span id="selectedDateText">[please select a date]</span></h3>
        <div id="slotsContainer" class="slots-grid">
        </div>
        <span id="slotError" style="color:red;display:none;">Please select at least one slot to book.</span>
    </div>

    <div class="section">
        <button id="bookNowBtn" class="btn-primary">Book Now</button>
    </div>

    <div id="qrCodeContainer" class="qr-container hidden">
        <h3>Your Booking QR Code</h3>
        <div id="qrcode"></div>
    </div>
</div>

<div class="owner-section">
    <h2>Owner's Panel</h2>
    <div class="section">
        <p>Select a date</p>
        <input type="date" id="ownerDate" class="input-date" required>
        <button id="showSlotsBtn" class="btn-secondary">Show Booking Slots</button>
        <span id="ownerDateError" style="color:red;display:none;">Please select a date in the owner's panel.</span>
    </div>
    <div class="section">
        <p>Please select date to view booking slots.</p>
        <div id="ownerSlotsContainer" class="slots-grid">
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    // A simple database to store booked and blocked slots
    let bookedSlots = {};
    let blockedSlots = {};

    // Get HTML elements
    const bookingDateInput = document.getElementById('bookingDate');
    const slotsContainer = document.getElementById('slotsContainer');
    const bookNowBtn = document.getElementById('bookNowBtn');
    const qrCodeContainer = document.getElementById('qrCodeContainer');
    const ownerDateInput = document.getElementById('ownerDate');
    const ownerSlotsContainer = document.getElementById('ownerSlotsContainer');
    const showSlotsBtn = document.getElementById('showSlotsBtn');
    const selectedDateText = document.getElementById('selectedDateText');
    const dateError = document.getElementById('dateError');
    const slotError = document.getElementById('slotError');
    const ownerDateError = document.getElementById('ownerDateError');

    const sports = ['football', 'cricket', 'volleyball'];
    const timeSlots = [];
    for (let i = 0; i < 24; i++) {
        timeSlots.push(`${i.toString().padStart(2, '0')}:00 - ${(i + 1).toString().padStart(2, '0')}:00`);
    }

    // Function to generate slots for a given date and display them
    function generateAndDisplaySlots(date, container, isOwnerView = false) {
        container.innerHTML = ''; // Clear previous slots
        const dateKey = date;

        timeSlots.forEach(slot => {
            const slotDiv = document.createElement('div');
            slotDiv.classList.add('slot');
            slotDiv.textContent = slot;
            slotDiv.dataset.slot = slot;

            // Check for both booked and blocked status
            const isBooked = (bookedSlots[dateKey] && bookedSlots[dateKey].includes(slot));
            const isBlocked = (blockedSlots[dateKey] && blockedSlots[dateKey].includes(slot));

            if (isBooked || isBlocked) {
                slotDiv.classList.add('booked');
            }

            // Add click listeners
            if (isOwnerView) {
                // Owner can toggle block status and unbook user slots
                slotDiv.addEventListener('click', () => toggleOwnerControl(slot, dateKey, slotDiv));
            } else {
                // Users can only select available slots
                if (!isBooked && !isBlocked) {
                    slotDiv.addEventListener('click', () => toggleSelectSlot(slotDiv));
                }
            }

            container.appendChild(slotDiv);
        });
    }

    // User side: Toggle selected slots
    function toggleSelectSlot(slotDiv) {
        slotDiv.classList.toggle('selected');
    }

    // New Function: Owner's control to unbook or block slots
    function toggleOwnerControl(slot, dateKey, slotDiv) {
        // Check if the slot is already booked by a user
        const isBookedByUser = bookedSlots[dateKey] && bookedSlots[dateKey].includes(slot);

        if (isBookedByUser) {
            // If it's a user-booked slot, unbook it
            const index = bookedSlots[dateKey].indexOf(slot);
            bookedSlots[dateKey].splice(index, 1);
        } else {
            // If it's not a user-booked slot, then toggle the manual blocked status
            if (!blockedSlots[dateKey]) {
                blockedSlots[dateKey] = [];
            }
            const index = blockedSlots[dateKey].indexOf(slot);
            if (index > -1) {
                blockedSlots[dateKey].splice(index, 1); // Unblock it
            } else {
                blockedSlots[dateKey].push(slot); // Block it
            }
        }

        // Crucial: Re-render both panels to reflect the change
        generateAndDisplaySlots(dateKey, ownerSlotsContainer, true);
        if (bookingDateInput.value === dateKey) {
            generateAndDisplaySlots(dateKey, slotsContainer);
        }
    }

    // Event Listeners
    bookingDateInput.addEventListener('change', (e) => {
        const selectedDate = e.target.value;
        selectedDateText.textContent = selectedDate;
        dateError.style.display = 'none';
        if (selectedDate) {
            generateAndDisplaySlots(selectedDate, slotsContainer);
        }
    });

    bookNowBtn.addEventListener('click', () => {
        slotError.style.display = 'none';
        dateError.style.display = 'none';

        const bookingDate = bookingDateInput.value;
        if (!bookingDate) {
            dateError.style.display = 'inline';
            return;
        }

        const selectedSlots = document.querySelectorAll('.slot.selected');
        if (selectedSlots.length === 0) {
            slotError.style.display = 'inline';
            return;
        }

        const bookingDetails = {
            sport: document.querySelector('input[name="sport"]:checked').value,
            date: bookingDate,
            slots: Array.from(selectedSlots).map(slot => slot.dataset.slot)
        };

        if (!bookedSlots[bookingDate]) {
            bookedSlots[bookingDate] = [];
        }
        bookingDetails.slots.forEach(slot => {
            bookedSlots[bookingDate].push(slot);
        });

        // Generate QR code with booking details
        generateQRCode(JSON.stringify(bookingDetails));

        // Update the UI
        selectedSlots.forEach(slot => {
            slot.classList.remove('selected');
            slot.classList.add('booked');
        });
    });

    // Owner's panel
    showSlotsBtn.addEventListener('click', () => {
        ownerDateError.style.display = 'none';
        const ownerDate = ownerDateInput.value;
        if (ownerDate) {
            generateAndDisplaySlots(ownerDate, ownerSlotsContainer, true);
        } else {
            ownerDateError.style.display = 'inline';
        }
    });

    // QR Code generation function
    function generateQRCode(text) {
        const qrCodeDiv = document.getElementById('qrcode');
        qrCodeDiv.innerHTML = '';
        qrCodeContainer.classList.remove('hidden');

        new QRCode(qrCodeDiv, {
            text: text,
            width: 128,
            height: 128,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
    }
</script>

<script>
    // Add this JavaScript to handle the date input
document.getElementById('bookingDate').addEventListener('focus', function() {
    this.classList.add('focused');
});

document.getElementById('bookingDate').addEventListener('blur', function() {
    if (this.value === '') {
        this.classList.remove('focused');
    }
});
</script>

</body>
</html>